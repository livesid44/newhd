@model VisitManagement.ViewModels.DashboardViewModel
@{
    ViewData["Title"] = "Dashboard";
}

<div class="white-bg-main p-4 mb-4">
    <div class="row mb-3">
        <div class="col-md-12">
            <h4 class="text-danger mb-0"><i class="bi bi-speedometer2"></i> Dashboard</h4>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="row mb-4">
        <div class="col-md-4 mb-3">
            <div class="card border-0 shadow-sm">
                <div class="card-body text-center">
                    <i class="bi bi-calendar-check text-primary" style="font-size: 2.5rem;"></i>
                    <h2 class="mt-3 mb-0 text-primary">@Model.TotalVisits</h2>
                    <p class="text-muted mb-0">Total Visits</p>
                </div>
            </div>
        </div>
        <div class="col-md-4 mb-3">
            <div class="card border-0 shadow-sm">
                <div class="card-body text-center">
                    <i class="bi bi-check-circle text-success" style="font-size: 2.5rem;"></i>
                    <h2 class="mt-3 mb-0 text-success">@Model.ConfirmedVisits</h2>
                    <p class="text-muted mb-0">Confirmed Visits</p>
                </div>
            </div>
        </div>
        <div class="col-md-4 mb-3">
            <div class="card border-0 shadow-sm">
                <div class="card-body text-center">
                    <i class="bi bi-clock-history text-warning" style="font-size: 2.5rem;"></i>
                    <h2 class="mt-3 mb-0 text-warning">@Model.TentativeVisits</h2>
                    <p class="text-muted mb-0">Tentative Visits</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Section -->
    <div class="row mb-4">
        <!-- Date-wise Chart -->
        <div class="col-md-@(Model.IsAdmin ? "6" : "12") mb-3">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white">
                    <h5 class="mb-0 text-danger"><i class="bi bi-bar-chart"></i> Date-wise Visit Count (Last 30 Days)</h5>
                </div>
                <div class="card-body">
                    @if (Model.DateWiseStats.Any())
                    {
                        <canvas id="dateWiseChart" style="max-height: 300px;"></canvas>
                    }
                    else
                    {
                        <p class="text-muted text-center py-4">No visits in the last 30 days</p>
                    }
                </div>
            </div>
        </div>

        <!-- User-wise Chart (Admin Only) -->
        @if (Model.IsAdmin && Model.UserWiseStats.Any())
        {
            <div class="col-md-6 mb-3">
                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-white">
                        <h5 class="mb-0 text-danger"><i class="bi bi-people"></i> User-wise Visit Count (Top 10)</h5>
                    </div>
                    <div class="card-body">
                        <canvas id="userWiseChart" style="max-height: 300px;"></canvas>
                    </div>
                </div>
            </div>
        }
    </div>

    <!-- Recent and Upcoming Visits -->
    <div class="row">
        <!-- Recent Visits -->
        <div class="col-md-6 mb-3">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white">
                    <h5 class="mb-0 text-danger"><i class="bi bi-clock-history"></i> Recent Visits</h5>
                </div>
                <div class="card-body p-0">
                    @if (Model.RecentVisits.Any())
                    {
                        <div class="table-responsive">
                            <table class="table table-sm table-hover mb-0" style="font-size: 13px;">
                                <thead>
                                    <tr style="background-color: #e6e7e8;">
                                        <th style="color: #e31837;">Account</th>
                                        <th style="color: #e31837;">Date</th>
                                        <th style="color: #e31837;">Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var visit in Model.RecentVisits)
                                    {
                                        <tr>
                                            <td>@visit.AccountName</td>
                                            <td>@visit.VisitDate.ToString("dd/MM/yyyy")</td>
                                            <td>
                                                <span class="badge @(visit.VisitStatus == VisitManagement.Models.VisitStatus.Confirmed ? "bg-success" : "bg-warning")">
                                                    @visit.VisitStatus
                                                </span>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    }
                    else
                    {
                        <p class="text-muted text-center py-4">No recent visits</p>
                    }
                </div>
            </div>
        </div>

        <!-- Upcoming Visits -->
        <div class="col-md-6 mb-3">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white">
                    <h5 class="mb-0 text-danger"><i class="bi bi-calendar-event"></i> Upcoming Visits</h5>
                </div>
                <div class="card-body p-0">
                    @if (Model.UpcomingVisits.Any())
                    {
                        <div class="table-responsive">
                            <table class="table table-sm table-hover mb-0" style="font-size: 13px;">
                                <thead>
                                    <tr style="background-color: #e6e7e8;">
                                        <th style="color: #e31837;">Account</th>
                                        <th style="color: #e31837;">Date</th>
                                        <th style="color: #e31837;">Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var visit in Model.UpcomingVisits)
                                    {
                                        <tr>
                                            <td>@visit.AccountName</td>
                                            <td>@visit.VisitDate.ToString("dd/MM/yyyy")</td>
                                            <td>
                                                <span class="badge @(visit.VisitStatus == VisitManagement.Models.VisitStatus.Confirmed ? "bg-success" : "bg-warning")">
                                                    @visit.VisitStatus
                                                </span>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    }
                    else
                    {
                        <p class="text-muted text-center py-4">No upcoming visits</p>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script>
        // Date-wise Chart
        @if (Model.DateWiseStats.Any())
        {
            <text>
            var dateWiseCtx = document.getElementById('dateWiseChart').getContext('2d');
            var dateWiseChart = new Chart(dateWiseCtx, {
                type: 'line',
                data: {
                    labels: [@Html.Raw(string.Join(",", Model.DateWiseStats.Select(d => $"'{d.Date:dd/MM}'")))],
                    datasets: [{
                        label: 'Visits',
                        data: [@Html.Raw(string.Join(",", Model.DateWiseStats.Select(d => d.Count)))],
                        borderColor: '#e31837',
                        backgroundColor: 'rgba(227, 24, 55, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });
            </text>
        }

        // User-wise Chart (Admin Only)
        @if (Model.IsAdmin && Model.UserWiseStats.Any())
        {
            <text>
            var userWiseCtx = document.getElementById('userWiseChart').getContext('2d');
            var userWiseChart = new Chart(userWiseCtx, {
                type: 'bar',
                data: {
                    labels: [@Html.Raw(string.Join(",", Model.UserWiseStats.Select(u => $"'{u.UserEmail.Split('@')[0]}'")))],
                    datasets: [{
                        label: 'Visits',
                        data: [@Html.Raw(string.Join(",", Model.UserWiseStats.Select(u => u.Count)))],
                        backgroundColor: '#0a0838',
                        borderColor: '#0a0838',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });
            </text>
        }
    </script>
}
